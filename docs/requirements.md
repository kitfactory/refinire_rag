# 要件定義書

## プロジェクトの目的・背景

refinire-ragは、RAG（Retrieval-Augmented Generation）システムの開発・運用を効率化するPythonライブラリです。以下の課題を解決することを目的としています：

1. **複雑なRAGシステムの構築** - 文書の前処理、ベクトル化、検索、回答生成まで一貫したパイプラインが必要
2. **品質管理の困難さ** - RAGシステムの精度評価や矛盾検出が手動では困難
3. **柔軟性の欠如** - 異なるベクトルストアやEmbeddingモデルの切り替えが困難

本ライブラリは、Refinireライブラリのサブパッケージとして、Step型のインターフェースを持つアプリケーションクラスと、依存性注入可能な背後モジュールによって、これらの課題を解決します。

## 利用者と困りごと

| 利用者の種類 | 利用者のゴール | 利用者の制約 | 利用者の困りごと |
|---|---|---|---|
| データサイエンティスト | 高精度なRAGシステムを構築したい | 限られた開発時間、様々なドキュメント形式への対応 | 文書の前処理、チャンキング、Embedding生成の実装が煩雑 |
| MLエンジニア | RAGシステムの品質を定量的に評価したい | 評価データセットの作成コスト、矛盾検出の自動化 | 手動での評価は時間がかかり、網羅的な矛盾検出は困難 |
| システムアーキテクト | 本番環境に適したRAGシステムを構築したい | 異なるインフラ環境への対応、スケーラビリティの確保 | ベクトルストアやEmbeddingモデルの切り替えが困難 |
| ドメインエキスパート | 専門用語や略語を含む文書を正確に処理したい | 専門知識の形式化、用語の統一 | 辞書作成や用語正規化の自動化が必要 |

## 採用する技術スタック

| カテゴリ | 技術・ライブラリ | 用途 |
|---|---|---|
| 言語 | Python 3.10+ | メイン開発言語 |
| フレームワーク | Refinire | エージェント・フロー管理 |
| LLMインテグレーション | agents-sdk-models v0.22+ | LLMアクセス、Flow/Step構造 |
| ベクトルストア | InMemory（標準）, Chroma, Faiss | ベクトル検索・保存 |
| Embedding | TF-IDF（標準）, OpenAI Embeddings | テキストのベクトル化 |
| 設定管理 | YAML + Pydantic | 設定ファイルのバリデーション |
| モニタリング | OpenTelemetry | トレーシング、メトリクス収集 |
| テスト | pytest, pytest-cov | ユニットテスト、カバレッジ測定 |
| パッケージ管理 | uv | 依存関係管理、ビルド |

## 機能（アプリケーション）一覧

| 機能名 | 概要 | 機能のイメージ |
|---|---|---|
| CorpusManager | 文書コーパスの構築・管理 | 複数の文書ファイルを読み込み、正規化・チャンク化・ベクトル化して保存。辞書やグラフも自動生成 |
| QueryEngine | クエリに対する回答生成 | ユーザーのクエリを受けて、関連文書を検索・再ランキングし、コンテキストに基づいた回答を生成 |
| QualityLab | RAGシステムの品質評価 | 評価データセットの作成、自動評価の実行、矛盾検出、改善レポートの生成を行う品質管理ツール |
| Loader | 外部ファイルの読み込み | PDF、Word、Markdown等の様々な形式のファイルをDocumentオブジェクトに変換 |
| DictionaryMaker | 辞書・略語抽出 | 文書から専門用語や略語を自動抽出し、辞書ファイルを生成 |
| Normalizer | 文書正規化 | 辞書に基づいて用語の統一やタグ付けを実行 |
| GraphBuilder | 関係グラフ構築 | 文書から主語-述語-目的語の関係を抽出し、ナレッジグラフを構築 |
| Chunker | 文書分割 | トークン数に基づいて文書を適切なサイズのチャンクに分割 |
| Embedder | ベクトル化 | チャンクをベクトル表現に変換 |
| StoreAdapter | ベクトルストア操作 | ベクトルの保存・検索インターフェースを提供（複数バックエンド対応） |
| Retriever | 文書検索 | クエリに関連する文書チャンクを検索 |
| Reranker | 再ランキング | 検索結果を精度向上のため再順位付け |
| Reader | 回答生成 | 検索結果とクエリから最終的な回答を生成 |
| TestSuite | 評価実行 | RAGパイプライン全体の評価を自動実行 |
| Evaluator | メトリクス集計 | 評価結果からメトリクスを計算・集計 |
| ContradictionDetector | 矛盾検出 | 文書間の矛盾するクレームをNLIで検出 |
| InsightReporter | レポート生成 | 評価結果から改善点を分析しレポートを生成 |